---
interface GalleryItemProps {
  src: string;
  alt?: string;
  index?: number;
}

const { src, alt = "", index = 0 } = Astro.props as GalleryItemProps;
const description = alt ?? "";

declare global {
  interface Window {
    __galleryLightboxInitialized?: boolean;
  }
}
---

<figure
  class="group overflow-hidden rounded-xl shadow-md transition-transform duration-200 hover:scale-[1.03] focus-within:scale-[1.03] cursor-pointer"
  data-gallery-item
  data-gallery-index={index}
  data-gallery-src={src}
  data-gallery-alt={description}
>
  <button
    type="button"
    class="block w-full focus:outline-none focus-visible:ring-2 focus-visible:ring-white/80 focus-visible:ring-offset-2 focus-visible:ring-offset-black/60"
    data-gallery-trigger
    aria-label={description ? `Agrandir l'image : ${description}` : "Agrandir l'image"}
  >
    <img
      src={src}
      alt={description}
      loading="lazy"
      decoding="async"
      class="w-full h-auto object-cover transition-transform duration-200 group-hover:scale-[1.03]"
    />
  </button>
</figure>

<script type="module">
  const initGalleryLightbox = () => {
    const itemSelector = '[data-gallery-item]';
    const triggerSelector = '[data-gallery-trigger]';

    const collectItems = () => {
      return Array.from(document.querySelectorAll(itemSelector)).map((item, idx) => {
        item.setAttribute('data-gallery-index', String(idx));
        return item;
      });
    };

    const items = collectItems();
    if (!items.length) return;

    let overlay = document.querySelector('[data-gallery-overlay]');

    if (!overlay) {
      overlay = document.createElement('div');
      overlay.setAttribute('data-gallery-overlay', 'true');
      overlay.className =
        'fixed inset-0 z-50 hidden items-center justify-center bg-black/90 p-4';
      overlay.setAttribute('role', 'dialog');
      overlay.setAttribute('aria-modal', 'true');
      overlay.innerHTML = `
        <div class="relative mx-auto flex max-h-[90vh] max-w-[90vw] items-center justify-center">
          <button
            type="button"
            data-gallery-prev
            aria-label="Photo précédente"
            class="absolute left-3 top-1/2 -translate-y-1/2 rounded-full bg-black/70 p-2 sm:p-3 text-white transition hover:bg-black/85 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
          >
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div data-gallery-image-container class="relative flex flex-col items-center">
            <img data-gallery-active-image src="" alt="" class="max-h-[80vh] max-w-full rounded-xl shadow-2xl" />
            <p data-gallery-caption class="mt-3 text-center text-sm text-neutral-200"></p>
            <button
              type="button"
              data-gallery-close
              aria-label="Fermer la galerie"
              class="absolute -top-4 -right-4 flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-full bg-black/80 text-white transition hover:bg-black focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <button
            type="button"
            data-gallery-next
            aria-label="Photo suivante"
            class="absolute right-3 top-1/2 -translate-y-1/2 rounded-full bg-black/70 p-2 sm:p-3 text-white transition hover:bg-black/85 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
          >
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    const imageEl = overlay.querySelector('[data-gallery-active-image]');
    const captionEl = overlay.querySelector('[data-gallery-caption]');
    const closeBtn = overlay.querySelector('[data-gallery-close]');
    const prevBtn = overlay.querySelector('[data-gallery-prev]');
    const nextBtn = overlay.querySelector('[data-gallery-next]');

    if (!(imageEl instanceof HTMLImageElement) || !(closeBtn instanceof HTMLElement) || !(prevBtn instanceof HTMLElement) || !(nextBtn instanceof HTMLElement)) {
      return;
    }

    const focusableElements = () =>
      Array.from(overlay.querySelectorAll('button:not([disabled])'));

    let currentIndex = 0;
    let lastFocused = null;
    let previousBodyOverflow = '';

    const getItemData = (index) => {
      const item = items[index];
      if (!item) return null;
      return {
        src: item.getAttribute('data-gallery-src') ?? '',
        alt: item.getAttribute('data-gallery-alt') ?? '',
      };
    };

    const updateImage = () => {
      const data = getItemData(currentIndex);
      if (!data) return;

      imageEl.src = data.src;
      imageEl.alt = data.alt;

      if (captionEl instanceof HTMLElement) {
        captionEl.textContent = data.alt;
        captionEl.hidden = !data.alt;
      }

      const label = data.alt ? `Agrandissement : ${data.alt}` : 'Agrandissement de l’image';
      overlay?.setAttribute('aria-label', label);
    };

    const goTo = (index) => {
      const total = items.length;
      currentIndex = ((index % total) + total) % total;
      updateImage();
    };

    const onKeyDown = (event) => {
      if (!overlay || overlay.classList.contains('hidden')) return;

      switch (event.key) {
        case 'Escape':
          event.preventDefault();
          close();
          break;
        case 'ArrowRight':
          event.preventDefault();
          goTo(currentIndex + 1);
          break;
        case 'ArrowLeft':
          event.preventDefault();
          goTo(currentIndex - 1);
          break;
        case 'Tab': {
          const focusable = focusableElements();
          if (!focusable.length) return;

          const first = focusable[0];
          const last = focusable[focusable.length - 1];
          const active = document.activeElement instanceof HTMLElement ? document.activeElement : null;

          if (event.shiftKey) {
            if (active === first || !focusable.includes(active ?? first)) {
              event.preventDefault();
              last.focus();
            }
          } else if (active === last) {
            event.preventDefault();
            first.focus();
          }
          break;
        }
        default:
          break;
      }
    };

    const open = (index) => {
      if (!overlay) return;
      lastFocused = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      previousBodyOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';

      goTo(index);

      overlay.classList.remove('hidden');
      overlay.classList.add('flex');
      overlay.dataset.open = 'true';

      const focusable = focusableElements();
      focusable[0]?.focus();

      document.addEventListener('keydown', onKeyDown);
    };

    const close = () => {
      if (!overlay) return;
      overlay.classList.add('hidden');
      overlay.classList.remove('flex');
      overlay.dataset.open = 'false';
      document.body.style.overflow = previousBodyOverflow;
      document.removeEventListener('keydown', onKeyDown);

      if (lastFocused) {
        lastFocused.focus();
      }
    };

    overlay.addEventListener('click', (event) => {
      if (event.target === overlay) {
        close();
      }
    });

    closeBtn.addEventListener('click', (event) => {
      event.preventDefault();
      close();
    });

    prevBtn.addEventListener('click', (event) => {
      event.preventDefault();
      goTo(currentIndex - 1);
    });

    nextBtn.addEventListener('click', (event) => {
      event.preventDefault();
      goTo(currentIndex + 1);
    });

    items.forEach((item, idx) => {
      const trigger = item.querySelector(triggerSelector);
      if (!(trigger instanceof HTMLElement)) return;
      if (trigger.dataset.galleryBound === 'true') return;

      trigger.dataset.galleryBound = 'true';

      trigger.addEventListener('click', (event) => {
        event.preventDefault();
        open(idx);
      });

      trigger.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          open(idx);
        }
      });
    });
  };

  const FLAG = '__galleryLightboxInitialized';

  if (typeof window !== 'undefined' && !window.__galleryLightboxInitialized) {
    window.__galleryLightboxInitialized = true;

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initGalleryLightbox, { once: true });
    } else {
      initGalleryLightbox();
    }
  }
</script>
